<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>xeokit BIM Viewer - Construction Progress (FIXED)</title>

  <!-- xeokit SDK - UMD build for browser -->
  <script src="https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/xeokit-sdk.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #1a1a1a;
    }

    #viewerCanvas {
      width: 100%;
      height: 100vh;
      position: absolute;
      top: 0; left: 0;
    }

    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar {
      position: absolute;
      top: 16px; left: 16px;
      background: rgba(255,255,255,0.96);
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .toolbar button {
      padding: 7px 14px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .toolbar button:hover  { background: #1557b0; }
    .toolbar button:disabled { background: #ccc; cursor: not-allowed; }
    .toolbar .sep {
      width: 1px; height: 28px;
      background: #ddd; margin: 0 4px;
    }

    /* â”€â”€ Status Panel â”€â”€ */
    .status-panel {
      position: absolute;
      bottom: 16px; left: 16px;
      background: rgba(255,255,255,0.96);
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 12px;
      color: #333;
      min-width: 180px;
    }
    .status-panel .row { margin: 3px 0; display: flex; gap: 6px; }
    .status-panel .lbl { font-weight: 600; min-width: 80px; color: #555; }

    /* â”€â”€ Info Panel â”€â”€ */
    .info-panel {
      position: absolute;
      top: 16px; right: 16px;
      background: rgba(255,255,255,0.96);
      padding: 14px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 280px;
      display: none;
    }
    .info-panel h3 { margin: 0 0 10px; color: #1a73e8; font-size: 15px; }
    .info-panel .close {
      position: absolute; top: 6px; right: 8px;
      background: none; border: none; font-size: 18px;
      cursor: pointer; color: #888; padding: 2px 6px;
    }
    .info-panel .close:hover { color: #333; }
    .info-row { margin: 6px 0; font-size: 12px; }
    .info-row .k { display: block; font-weight: 600; color: #666; margin-bottom: 1px; }
    .info-row .v { color: #222; }

    /* â”€â”€ Legend â”€â”€ */
    .legend {
      position: absolute;
      bottom: 16px; right: 16px;
      background: rgba(255,255,255,0.96);
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 12px;
    }
    .legend h4 { margin: 0 0 7px; font-size: 13px; color: #333; }
    .legend-item {
      display: flex; align-items: center; margin: 5px 0;
    }
    .legend-swatch {
      width: 18px; height: 18px;
      border-radius: 3px; margin-right: 7px;
      border: 1px solid rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    /* â”€â”€ Loading overlay â”€â”€ */
    .overlay {
      position: absolute; inset: 0;
      background: rgba(18,18,26,0.92);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 2000; color: #fff;
    }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #4da6ff;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      margin-bottom: 18px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loadingText { font-size: 15px; opacity: 0.85; margin-top: 6px; }
    #loadingSubtext { font-size: 12px; opacity: 0.55; margin-top: 4px; }

    /* â”€â”€ Error banner â”€â”€ */
    .error-banner {
      position: absolute;
      top: 80px; left: 50%;
      transform: translateX(-50%);
      background: #c62828;
      color: #fff;
      padding: 12px 20px;
      border-radius: 6px;
      z-index: 3000;
      display: none;
      max-width: 500px;
      font-size: 13px;
      text-align: center;
      box-shadow: 0 3px 12px rgba(0,0,0,0.4);
    }
    .error-banner a { color: #ffcc80; }
    .error-banner code { 
      background: rgba(255,255,255,0.2); 
      padding: 2px 6px; 
      border-radius: 3px; 
      font-family: monospace;
    }

    /* â”€â”€ Notification toast â”€â”€ */
    .toast {
      position: absolute;
      top: 72px; left: 50%;
      transform: translateX(-50%);
      background: #2e7d32;
      color: #fff;
      padding: 10px 22px;
      border-radius: 4px;
      z-index: 2001;
      display: none;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      animation: slideDown 0.25s ease;
    }
    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to   { transform: translateX(-50%);       opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- Loading overlay -->
  <div id="overlay" class="overlay">
    <div class="spinner"></div>
    <div id="loadingText">Initializing xeokit viewerâ€¦</div>
    <div id="loadingSubtext"></div>
  </div>

  <!-- Canvas -->
  <canvas id="viewerCanvas"></canvas>

  <!-- Toolbar -->
  <div class="toolbar">
    <button id="fitBtn"        title="Fit all objects into view">ğŸ” Fit</button>
    <button id="homeBtn"       title="Reset camera to home position">ğŸ  Home</button>
    <div class="sep"></div>
    <button id="refreshBtn"    title="Re-fetch status colours from Google Sheets">ğŸ”„ Refresh</button>
    <div class="sep"></div>
    <button id="screenshotBtn" title="Download PNG screenshot">ğŸ“¸ Screenshot</button>
  </div>

  <!-- Status panel -->
  <div class="status-panel">
    <div class="row"><span class="lbl">Model:</span>    <span id="modelName">â€”</span></div>
    <div class="row"><span class="lbl">Objects:</span>  <span id="objectCount">0</span></div>
    <div class="row"><span class="lbl">Coloured:</span> <span id="coloredCount">0</span></div>
  </div>

  <!-- Info panel -->
  <div class="info-panel" id="infoPanel">
    <button class="close" onclick="closeInfoPanel()">Ã—</button>
    <h3>Element Info</h3>
    <div class="info-row"><span class="k">GUID</span>  <span class="v" id="iGuid">â€”</span></div>
    <div class="info-row"><span class="k">Name</span>  <span class="v" id="iName">â€”</span></div>
    <div class="info-row"><span class="k">Type</span>  <span class="v" id="iType">â€”</span></div>
    <div class="info-row"><span class="k">Status</span><span class="v" id="iStatus">â€”</span></div>
    <div class="info-row"><span class="k">Task</span>  <span class="v" id="iTask">â€”</span></div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <h4>Status Legend</h4>
    <div class="legend-item"><div class="legend-swatch" style="background:#D3D3D3"></div>Not Started</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#FFC000"></div>In Progress</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#70AD47"></div>Complete</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#FF4444"></div>On Hold</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#5B9BD5"></div>Under Review</div>
  </div>

  <!-- Error banner -->
  <div id="errorBanner" class="error-banner"></div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // GLOBALS & CONFIGURATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    let viewer        = null;
    let currentModel  = null;
    let statusLookup  = {};   // guid â†’ { status, color, taskId }
    let elementInfo   = {};   // guid â†’ { type, name, floor, category }

    const STATUS_COLORS = {
      'Not Started':  '#D3D3D3',
      'In Progress':  '#FFC000',
      'Complete':     '#70AD47',
      'On Hold':      '#FF4444',
      'Under Review': '#5B9BD5'
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // HELPER FUNCTIONS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    function hex2rgb(hex) {
      hex = hex.replace('#','');
      return [
        parseInt(hex.slice(0,2),16)/255,
        parseInt(hex.slice(2,4),16)/255,
        parseInt(hex.slice(4,6),16)/255
      ];
    }

    function setLoading(msg, sub) {
      document.getElementById('loadingText').textContent    = msg || '';
      document.getElementById('loadingSubtext').textContent = sub || '';
    }

    function hideOverlay() {
      document.getElementById('overlay').style.display = 'none';
    }

    function showToast(msg, isError) {
      const t = document.getElementById('toast');
      t.textContent        = msg;
      t.style.background   = isError ? '#b71c1c' : '#2e7d32';
      t.style.display      = 'block';
      clearTimeout(t._tid);
      t._tid = setTimeout(() => { t.style.display = 'none'; }, 3500);
    }

    function showError(msg) {
      const b = document.getElementById('errorBanner');
      b.innerHTML    = 'âš  ' + msg;
      b.style.display = 'block';
      hideOverlay();
      console.error('[Viewer Error]', msg);
    }

    function closeInfoPanel() {
      document.getElementById('infoPanel').style.display = 'none';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SDK DETECTION & VERIFICATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    function getSDK() {
      // Try different global namespace variations
      if (typeof xeokit !== 'undefined' && xeokit.Viewer) return xeokit;
      if (typeof XeoKit !== 'undefined' && XeoKit.Viewer) return XeoKit;
      if (typeof window.xeokit !== 'undefined' && window.xeokit.Viewer) return window.xeokit;
      return null;
    }

    function checkSDK() {
      const SDK = getSDK();
      if (!SDK) {
        showError(
          'xeokit SDK failed to load.<br><br>' +
          '<strong>Possible causes:</strong><br>' +
          'â€¢ Network blocking <code>cdn.jsdelivr.net</code><br>' +
          'â€¢ Content Security Policy restrictions<br>' +
          'â€¢ Ad blocker interference<br><br>' +
          '<strong>Expected global:</strong> <code>window.xeokit.Viewer</code><br><br>' +
          'Check browser console for errors.'
        );
        return false;
      }
      return true;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // MAIN INITIALIZATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    async function initViewer() {
      // Step 1: Verify SDK loaded
      if (!checkSDK()) return;
      
      const SDK = getSDK();

      try {
        // Step 2: Create Viewer instance
        setLoading('Creating viewerâ€¦');
        
        viewer = new SDK.Viewer({
          canvasId : 'viewerCanvas',
          transparent: true,
          saoEnabled: false  // Disable ambient occlusion for better performance
        });

        console.log('âœ“ Viewer created');

        // Step 3: Configure camera BEFORE any operations
        setLoading('Configuring cameraâ€¦');
        
        viewer.camera.eye  = [-20, 12, 22];
        viewer.camera.look = [0,   0,  0];
        viewer.camera.up   = [0,   1,  0];
        viewer.cameraControl.followPointer = true;

        console.log('âœ“ Camera configured');

        // Step 4: Setup interaction handlers
        viewer.cameraControl.on('picked', (hit) => {
          if (hit && hit.entity) showElementInfo(hit.entity);
        });

        // Step 5: Load model
        setLoading('Loading modelâ€¦', 'Fetching XKT file');
        await loadModel(SDK);

        // Step 6: Apply status colors
        setLoading('Applying status coloursâ€¦');
        await applyColors();

        // Step 7: Setup toolbar
        setupToolbar();

        // Step 8: Done
        hideOverlay();
        showToast('Model loaded successfully âœ“');
        console.log('âœ“ Viewer initialization complete');

      } catch (err) {
        console.error('Initialization error:', err);
        showError('Viewer init failed: ' + err.message + '<br><br>Check console for details.');
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // MODEL LOADING
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    function loadModel(SDK) {
      return new Promise((resolve, reject) => {
        
        // Fallback demo model for testing
        const DEMO_MODEL = 
          'https://xeokit.github.io/xeokit-sdk/examples/models/xkt/v10/' +
          'glTF-Embedded/Duplex_A_20110505.glTFEmbedded.xkt';

        function doLoad(src, name) {
          console.log('Loading model from:', src);
          
          const loader = new SDK.XKTLoaderPlugin(viewer);
          
          currentModel = loader.load({
            id   : 'bimModel',
            src  : src,
            edges: true,
            performance: true
          });

          currentModel.on('loaded', () => {
            const n = Object.keys(viewer.scene.objects).length;
            console.log('âœ“ Model loaded:', n, 'objects');
            
            document.getElementById('modelName').textContent  = name;
            document.getElementById('objectCount').textContent = n;
            resolve();
          });

          currentModel.on('error', (e) => {
            console.error('Model load error:', e);
            reject(new Error('XKT load failed: ' + e));
          });
        }

        // Check if running in Google Apps Script context
        if (typeof google !== 'undefined' && google.script) {
          console.log('Attempting to load model via Google Apps Script...');
          
          google.script.run
            .withSuccessHandler((cfg) => {
              if (cfg && cfg.fileId) {
                const driveUrl = 
                  'https://drive.google.com/uc?export=download&id=' + cfg.fileId;
                console.log('Using Drive URL:', driveUrl);
                doLoad(driveUrl, cfg.projectName || 'BIM Model');
              } else {
                console.log('No file ID returned, using demo model');
                doLoad(DEMO_MODEL, 'Demo Model (Duplex)');
              }
            })
            .withFailureHandler((err) => {
              console.warn('Apps Script call failed:', err);
              console.log('Falling back to demo model');
              doLoad(DEMO_MODEL, 'Demo Model (Duplex)');
            })
            .getModelData();
        } else {
          // Not in Apps Script environment - use demo
          console.log('Not in Apps Script environment, using demo model');
          doLoad(DEMO_MODEL, 'Demo Model (Duplex)');
        }
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // COLOR APPLICATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    async function applyColors() {
      let data = null;

      // Try fetching live status from Google Sheets
      if (typeof google !== 'undefined' && google.script) {
        try {
          console.log('Fetching element status from Google Sheets...');
          data = await new Promise((res, rej) => {
            google.script.run
              .withSuccessHandler(res)
              .withFailureHandler(rej)
              .getElementStatus();
          });
          console.log('âœ“ Status data received:', Object.keys(data.statusMap || {}).length, 'elements');
        } catch (err) {
          console.warn('Failed to fetch status from Sheets:', err);
        }
      }

      let coloured = 0;

      if (data && data.statusMap) {
        // Apply real data from Sheets
        statusLookup = data.statusMap;
        elementInfo  = data.elementInfo || {};

        Object.entries(statusLookup).forEach(([guid, info]) => {
          const ent = viewer.scene.objects[guid];
          if (ent) {
            ent.colorize = info.color || hex2rgb(
              STATUS_COLORS[info.status] || STATUS_COLORS['Not Started']
            );
            coloured++;
          }
        });

        console.log('âœ“ Applied', coloured, 'element colors from Sheets');

      } else {
        // Demo: colour every object by index pattern
        console.log('Applying demo colors...');
        const objs = Object.keys(viewer.scene.objects);
        const palette = Object.values(STATUS_COLORS).map(hex2rgb);
        
        objs.forEach((id, i) => {
          const ent = viewer.scene.objects[id];
          if (ent) {
            ent.colorize = palette[i % palette.length];
            coloured++;
          }
        });
        
        showToast('Using demo colors (no Sheets data available)', false);
        console.log('âœ“ Applied', coloured, 'demo colors');
      }

      document.getElementById('coloredCount').textContent = coloured;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ELEMENT INFO DISPLAY
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    function showElementInfo(entity) {
      const guid = entity.id;
      const info = elementInfo[guid]   || {};
      const stat = statusLookup[guid]  || {};

      document.getElementById('iGuid').textContent   = guid;
      document.getElementById('iName').textContent   = info.name     || guid.slice(0,22) + '...';
      document.getElementById('iType').textContent   = info.type     || 'IfcElement';
      document.getElementById('iStatus').textContent = stat.status   || 'Unknown';
      document.getElementById('iTask').textContent   = stat.taskId   || 'â€”';
      
      document.getElementById('infoPanel').style.display = 'block';
      
      console.log('Selected element:', guid);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // TOOLBAR SETUP
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    function setupToolbar() {
      document.getElementById('fitBtn').onclick = () => {
        viewer.cameraFlight.flyTo(viewer.scene);
        showToast('Fitted to view');
      };

      document.getElementById('homeBtn').onclick = () => {
        viewer.cameraFlight.flyTo({
          eye: [-20, 12, 22], 
          look: [0,0,0], 
          up: [0,1,0]
        });
        showToast('Reset to home view');
      };

      document.getElementById('refreshBtn').onclick = async () => {
        showToast('Refreshing coloursâ€¦');
        await applyColors();
        showToast('Colours updated âœ“');
      };

      document.getElementById('screenshotBtn').onclick = () => {
        const snap = viewer.getSnapshot({ 
          width: 1920, 
          height: 1080, 
          format: 'png' 
        });
        
        const a = document.createElement('a');
        a.download = 'bim-screenshot-' + Date.now() + '.png';
        a.href = snap.imageData || snap;
        a.click();
        
        showToast('Screenshot saved âœ“');
      };
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // STARTUP
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    window.addEventListener('load', () => {
      console.log('=== xeokit BIM Viewer Starting ===');
      console.log('xeokit SDK available:', getSDK() !== null);
      
      // Small delay to ensure DOM is fully ready
      setTimeout(initViewer, 100);
    });

    // Error handler for uncaught errors
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.message, e.filename, e.lineno);
    });
  </script>
</body>
</html>