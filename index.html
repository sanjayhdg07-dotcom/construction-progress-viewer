<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Progress 3D Viewer</title>
  
  <!-- xeokit SDK from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk@2.3.8/dist/xeokit-sdk.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #1a1a1a;
    }
    
    #viewerCanvas {
      width: 100%;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    .toolbar {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .toolbar button {
      padding: 8px 16px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      font-family: inherit;
    }
    
    .toolbar button:hover {
      background: #1557b0;
    }
    
    .toolbar .divider {
      width: 1px;
      height: 30px;
      background: #ddd;
      margin: 0 5px;
    }
    
    .status-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 13px;
      color: #333;
    }
    
    .status-panel .status-item {
      margin: 4px 0;
    }
    
    .status-panel .status-label {
      font-weight: 500;
      display: inline-block;
      min-width: 120px;
    }
    
    .info-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 350px;
      display: none;
    }
    
    .info-panel h3 {
      margin: 0 0 12px 0;
      color: #1a73e8;
      font-size: 16px;
    }
    
    .info-panel .info-row {
      margin: 8px 0;
      font-size: 13px;
    }
    
    .info-panel .info-label {
      font-weight: 500;
      color: #666;
      display: block;
      margin-bottom: 2px;
    }
    
    .info-panel .info-value {
      color: #333;
      word-break: break-all;
    }
    
    .info-panel .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 4px;
    }
    
    .info-panel .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
      padding: 4px 8px;
    }
    
    .info-panel .close-btn:hover {
      color: #333;
    }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      color: white;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      margin-top: 10px;
      text-align: center;
      max-width: 80%;
    }
    
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 12px;
    }
    
    .legend h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #333;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      margin-right: 8px;
      border: 1px solid #ddd;
    }
    
    .notification {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
    }
    
    .error-message {
      background: #f44336;
    }
    
    .config-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      z-index: 3000;
      max-width: 500px;
      width: 90%;
    }
    
    .config-panel h2 {
      margin: 0 0 16px 0;
      color: #1a73e8;
    }
    
    .config-panel label {
      display: block;
      margin: 12px 0 4px 0;
      font-weight: 500;
      color: #333;
    }
    
    .config-panel input, .config-panel textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
    }
    
    .config-panel button {
      margin-top: 16px;
      padding: 10px 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .config-panel button:hover {
      background: #1557b0;
    }
    
    .config-panel .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Initializing 3D viewer...</div>
  </div>
  
  <div id="configPanel" class="config-panel" style="display: none;">
    <h2>‚öôÔ∏è Configuration</h2>
    <p>To connect to your Google Sheets data, you need the web app URL from your Apps Script deployment.</p>
    
    <label for="webAppUrl">Google Apps Script Web App URL:</label>
    <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/...">
    <div class="help-text">Get this from: Deploy ‚Üí New deployment ‚Üí Copy web app URL</div>
    
    <label for="xktUrl">XKT Model File URL:</label>
    <input type="text" id="xktUrl" placeholder="https://drive.google.com/uc?export=download&id=...">
    <div class="help-text">Or use demo model (leave blank)</div>
    
    <button onclick="saveConfig()">Save & Load Model</button>
    <button onclick="useDemoMode()" style="background: #666; margin-left: 8px;">Use Demo Mode</button>
  </div>
  
  <canvas id="viewerCanvas"></canvas>
  
  <div class="toolbar">
    <button id="fitBtn">üîç Fit View</button>
    <button id="homeBtn">üè† Reset Camera</button>
    <div class="divider"></div>
    <button id="refreshBtn">üîÑ Refresh Colors</button>
    <div class="divider"></div>
    <button id="screenshotBtn">üì∏ Screenshot</button>
    <div class="divider"></div>
    <button id="configBtn" onclick="showConfig()">‚öôÔ∏è Settings</button>
  </div>
  
  <div class="status-panel">
    <div class="status-item">
      <span class="status-label">Model:</span>
      <span id="modelName">Loading...</span>
    </div>
    <div class="status-item">
      <span class="status-label">Objects:</span>
      <span id="objectCount">0</span>
    </div>
    <div class="status-item">
      <span class="status-label">Colored:</span>
      <span id="coloredCount">0</span>
    </div>
    <div class="status-item">
      <span class="status-label">Data Source:</span>
      <span id="dataSource">Not Connected</span>
    </div>
  </div>
  
  <div class="info-panel" id="infoPanel">
    <button class="close-btn" onclick="closeInfoPanel()">√ó</button>
    <h3>Element Information</h3>
    <div class="info-row">
      <span class="info-label">GUID:</span>
      <span class="info-value" id="infoGuid">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Name:</span>
      <span class="info-value" id="infoName">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Type:</span>
      <span class="info-value" id="infoType">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Task Status:</span>
      <span class="info-value" id="infoStatus">
        <div class="status-badge" id="statusBadge">-</div>
      </span>
    </div>
    <div class="info-row">
      <span class="info-label">Task ID:</span>
      <span class="info-value" id="infoTaskId">-</span>
    </div>
  </div>
  
  <div class="legend">
    <h4>Task Status Legend</h4>
    <div class="legend-item">
      <div class="legend-color" style="background: #D3D3D3"></div>
      <span>Not Started</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #FFC000"></div>
      <span>In Progress</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #70AD47"></div>
      <span>Complete</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #FF0000"></div>
      <span>On Hold</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #5B9BD5"></div>
      <span>Under Review</span>
    </div>
  </div>
  
  <div id="notification" class="notification"></div>
  
  <script>
    // Configuration
    var CONFIG = {
      webAppUrl: localStorage.getItem('webAppUrl') || '',
      xktUrl: localStorage.getItem('xktUrl') || '',
      demoMode: false
    };
    
    // Global variables
    var viewer;
    var currentModel;
    var elementStatusData = {};
    var elementInfoData = {};
    
    // Check if configured on startup
    window.onload = function() {
      if (!CONFIG.webAppUrl && !CONFIG.xktUrl) {
        document.getElementById('configPanel').style.display = 'block';
        document.getElementById('loadingOverlay').style.display = 'none';
      } else {
        initViewer();
      }
    };
    
    function showConfig() {
      document.getElementById('configPanel').style.display = 'block';
      document.getElementById('webAppUrl').value = CONFIG.webAppUrl;
      document.getElementById('xktUrl').value = CONFIG.xktUrl;
    }
    
    function saveConfig() {
      CONFIG.webAppUrl = document.getElementById('webAppUrl').value.trim();
      CONFIG.xktUrl = document.getElementById('xktUrl').value.trim();
      CONFIG.demoMode = false;
      
      localStorage.setItem('webAppUrl', CONFIG.webAppUrl);
      localStorage.setItem('xktUrl', CONFIG.xktUrl);
      
      document.getElementById('configPanel').style.display = 'none';
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      initViewer();
    }
    
    function useDemoMode() {
      CONFIG.demoMode = true;
      CONFIG.webAppUrl = '';
      CONFIG.xktUrl = 'https://xeokit.github.io/xeokit-sdk/examples/models/xkt/v10/glTF-Embedded/Duplex_A_20110505.glTFEmbedded.xkt';
      
      document.getElementById('configPanel').style.display = 'none';
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      initViewer();
    }
    
    function initViewer() {
      try {
        updateLoadingText('Creating 3D viewer...');
        
        viewer = new xeokit.Viewer({
          canvasId: "viewerCanvas",
          transparent: true,
          saoEnabled: true
        });
        
        viewer.camera.eye = [-20, 10, 20];
        viewer.camera.look = [0, 0, 0];
        viewer.camera.up = [0, 1, 0];
        
        viewer.cameraControl.followPointer = true;
        
        viewer.cameraControl.on("picked", function(pickResult) {
          if (pickResult.entity) {
            showElementInfo(pickResult.entity);
          }
        });
        
        updateLoadingText('Loading 3D model...');
        loadModel();
        
      } catch (error) {
        console.error('Error initializing viewer:', error);
        showError('Failed to initialize viewer', error);
      }
    }
    
    function loadModel() {
      try {
        var xktLoader = new xeokit.XKTLoaderPlugin(viewer);
        
        var modelUrl = CONFIG.xktUrl || 'https://xeokit.github.io/xeokit-sdk/examples/models/xkt/v10/glTF-Embedded/Duplex_A_20110505.glTFEmbedded.xkt';
        
        currentModel = xktLoader.load({
          id: "myModel",
          src: modelUrl,
          edges: true
        });
        
        currentModel.on("loaded", function() {
          var numObjects = Object.keys(viewer.scene.objects).length;
          document.getElementById('modelName').textContent = CONFIG.demoMode ? 'Demo Building (Duplex)' : 'Your Building Model';
          document.getElementById('objectCount').textContent = numObjects;
          
          updateLoadingText('Fetching task statuses...');
          
          if (CONFIG.demoMode || !CONFIG.webAppUrl) {
            applyDemoColors();
            document.getElementById('dataSource').textContent = 'Demo Mode';
          } else {
            applyColorsFromSheets();
          }
          
          document.getElementById('loadingOverlay').style.display = 'none';
          setupToolbar();
          showNotification('Model loaded successfully!');
        });
        
        currentModel.on("error", function(error) {
          showError('Failed to load model', error);
        });
        
      } catch (error) {
        showError('Failed to load model', error);
      }
    }
    
    function applyColorsFromSheets() {
      if (!CONFIG.webAppUrl) {
        applyDemoColors();
        return;
      }
      
      fetch(CONFIG.webAppUrl + '?action=getElementStatus')
        .then(response => response.json())
        .then(data => {
          elementStatusData = data.statusMap;
          elementInfoData = data.elementInfo;
          
          var coloredCount = 0;
          
          for (var guid in elementStatusData) {
            var entity = viewer.scene.objects[guid];
            if (entity) {
              var statusInfo = elementStatusData[guid];
              entity.colorize = statusInfo.color;
              coloredCount++;
            }
          }
          
          document.getElementById('coloredCount').textContent = coloredCount;
          document.getElementById('dataSource').textContent = 'Google Sheets ‚úì';
          showNotification('Colors applied from Google Sheets!');
        })
        .catch(error => {
          console.error('Failed to fetch from Sheets:', error);
          applyDemoColors();
          document.getElementById('dataSource').textContent = 'Demo Colors (Sheets unavailable)';
        });
    }
    
    function applyDemoColors() {
      var objects = viewer.scene.objects;
      var coloredCount = 0;
      var i = 0;
      
      var statusColors = [
        [0.83, 0.83, 0.83], // Not Started - Gray
        [1.0, 0.75, 0.0],   // In Progress - Orange
        [0.44, 0.68, 0.28], // Complete - Green
        [1.0, 0.0, 0.0],    // On Hold - Red
        [0.36, 0.61, 0.84]  // Under Review - Blue
      ];
      
      for (var id in objects) {
        if (i % 5 === 0) {
          var colorIndex = Math.floor(Math.random() * statusColors.length);
          objects[id].colorize = statusColors[colorIndex];
          coloredCount++;
        }
        i++;
      }
      
      document.getElementById('coloredCount').textContent = coloredCount;
    }
    
    function showElementInfo(entity) {
      var infoPanel = document.getElementById('infoPanel');
      var guid = entity.id;
      
      var elementInfo = elementInfoData[guid] || {};
      var statusInfo = elementStatusData[guid] || {};
      
      document.getElementById('infoGuid').textContent = guid;
      document.getElementById('infoName').textContent = elementInfo.name || guid.substring(0, 20) + '...';
      document.getElementById('infoType').textContent = elementInfo.type || 'IfcBuildingElement';
      document.getElementById('infoTaskId').textContent = statusInfo.taskId || 'Not mapped';
      
      var status = statusInfo.status || 'Not mapped';
      var statusBadge = document.getElementById('statusBadge');
      statusBadge.textContent = status;
      
      var statusColors = {
        'Not Started': {bg: '#D3D3D3', text: '#000'},
        'In Progress': {bg: '#FFC000', text: '#000'},
        'Complete': {bg: '#70AD47', text: '#fff'},
        'On Hold': {bg: '#FF0000', text: '#fff'},
        'Under Review': {bg: '#5B9BD5', text: '#fff'},
        'Not mapped': {bg: '#999', text: '#fff'}
      };
      
      var colors = statusColors[status] || statusColors['Not mapped'];
      statusBadge.style.background = colors.bg;
      statusBadge.style.color = colors.text;
      
      infoPanel.style.display = 'block';
    }
    
    function closeInfoPanel() {
      document.getElementById('infoPanel').style.display = 'none';
    }
    
    function setupToolbar() {
      document.getElementById('fitBtn').onclick = function() {
        viewer.cameraFlight.flyTo(viewer.scene);
      };
      
      document.getElementById('homeBtn').onclick = function() {
        viewer.cameraFlight.jumpTo({
          eye: [-20, 10, 20],
          look: [0, 0, 0],
          up: [0, 1, 0]
        });
      };
      
      document.getElementById('refreshBtn').onclick = function() {
        showNotification('Refreshing colors...');
        if (CONFIG.demoMode || !CONFIG.webAppUrl) {
          applyDemoColors();
        } else {
          applyColorsFromSheets();
        }
      };
      
      document.getElementById('screenshotBtn').onclick = function() {
        var screenshot = viewer.getSnapshot({
          width: 1920,
          height: 1080,
          format: "png"
        });
        
        var link = document.createElement('a');
        var timestamp = new Date().toISOString().slice(0,10);
        link.download = 'construction-progress-' + timestamp + '.png';
        link.href = screenshot.imageData;
        link.click();
        
        showNotification('Screenshot saved!');
      };
    }
    
    function updateLoadingText(text) {
      document.getElementById('loadingText').textContent = text;
    }
    
    function showError(message, error) {
      updateLoadingText('Error: ' + message);
      console.error(message, error);
      alert(message + '\n\n' + (error.message || error.toString()));
      showNotification(message, true);
    }
    
    function showNotification(message, isError) {
      var notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification' + (isError ? ' error-message' : '');
      notification.style.display = 'block';
      
      setTimeout(function() {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>