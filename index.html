<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIM Construction Progress Viewer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—ï¸</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
:root {
  --bg:#0a0e17; --panel:rgba(15,20,32,0.95); --border:#1e2842;
  --accent:#4a8fff; --acct2:#00e5cc;
  --text:#d4dce8; --dim:#5a6580; --muted:#748099;
  --ns:#5a6580; --ip:#f5a623; --co:#4cd964; --oh:#ff3b30; --ur:#5ac8fa;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif}
#canvas{display:block;position:fixed;inset:0;cursor:grab}
#canvas:active{cursor:grabbing}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:18px}
.ld-logo{font-size:32px;font-weight:700;letter-spacing:.05em;color:var(--accent);margin-bottom:8px}
.ld-logo span{color:var(--acct2)}
.ld-bar{width:280px;height:4px;background:var(--border);border-radius:3px;overflow:hidden}
.ld-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--acct2));border-radius:3px;transition:width .4s ease}
.ld-txt{font-family:monospace;font-size:12px;color:var(--muted);letter-spacing:.03em}

/* TOOLBAR */
#toolbar{position:fixed;top:20px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:6px;background:var(--panel);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;padding:8px 14px;z-index:200;box-shadow:0 10px 40px rgba(0,0,0,.6);opacity:0;transition:opacity .5s;pointer-events:none}
#toolbar.vis{opacity:1;pointer-events:all}
.brand{font-weight:700;font-size:13px;letter-spacing:.08em;color:var(--accent);margin-right:8px;text-transform:uppercase}
.sep{width:1px;height:24px;background:var(--border);margin:0 4px;flex-shrink:0}
.btn{display:flex;align-items:center;gap:6px;padding:6px 14px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);font-family:'Inter',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .18s;white-space:nowrap}
.btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(74,143,255,.3)}
.btn.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* LEFT PANEL */
#panel-l{position:fixed;top:90px;left:20px;bottom:20px;width:240px;background:var(--panel);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;overflow:hidden;z-index:200;opacity:0;transition:opacity .5s;pointer-events:none}
#panel-l.vis{opacity:1;pointer-events:all}
.ph{padding:13px 16px 11px;border-bottom:1px solid var(--border);font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
.sbox{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:12px 8px;text-align:center}
.sval{font-size:24px;font-weight:700;color:var(--accent);line-height:1}
.slbl{font-size:9px;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-top:4px}
.prog-wrap{padding:0 12px 12px}
.prog-lbl{font-size:10px;color:var(--muted);margin-bottom:6px;display:flex;justify-content:space-between}
.prog-track{height:7px;background:var(--border);border-radius:4px;overflow:hidden}
.prog-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--acct2));transition:width .6s ease}
.legend{padding:0 12px 8px}
.legend-title{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
.li{display:flex;align-items:center;gap:9px;margin:6px 0;cursor:pointer;padding:5px 8px;border-radius:7px;transition:background .15s}
.li:hover{background:rgba(255,255,255,.05)}
.li.off{opacity:.3}
.lswatch{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.lname{font-size:11px;color:var(--text)}
.lcount{margin-left:auto;font-size:10px;font-family:monospace;color:var(--dim)}
.task-list{flex:1;overflow-y:auto;padding:6px 12px 12px}
.task-list::-webkit-scrollbar{width:4px}
.task-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.titem{padding:10px;border-radius:8px;margin:4px 0;border:1px solid transparent;cursor:pointer;transition:all .15s}
.titem:hover{background:rgba(255,255,255,.04);border-color:var(--border)}
.titem.sel{background:rgba(74,143,255,.15);border-color:var(--accent)}
.tname{font-size:11px;font-weight:600;margin-bottom:4px}
.tmeta{font-size:10px;color:var(--dim);display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.tstatus{padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700}

/* RIGHT INFO PANEL */
#panel-r{position:fixed;top:90px;right:20px;width:260px;background:var(--panel);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;z-index:200;display:none;overflow:hidden}
#panel-r.show{display:block}
.pr-head{padding:13px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.pr-head h3{font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--acct2)}
.pr-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;padding:0 3px}
.pr-close:hover{color:var(--text)}
.pr-body{padding:14px 16px}
.pr-row{margin:8px 0}
.pr-key{font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:3px}
.pr-val{font-size:11px;color:var(--text);font-family:monospace;word-break:break-all}
.pr-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;margin-top:3px}

/* FLOOR FILTER */
#floor-filter{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:6px;align-items:center;background:var(--panel);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:12px;padding:8px 12px;z-index:200;opacity:0;transition:opacity .5s;pointer-events:none}
#floor-filter.vis{opacity:1;pointer-events:all}
#floor-filter span{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-right:4px}
.fbtn{padding:5px 13px;border:1px solid var(--border);border-radius:7px;background:transparent;color:var(--text);font-family:'Inter',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.fbtn:hover,.fbtn.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);border-radius:9px;padding:10px 20px;font-size:11px;z-index:500;opacity:0;transition:opacity .25s;pointer-events:none;backdrop-filter:blur(14px);white-space:nowrap}
#toast.show{opacity:1}

/* SUCCESS BANNER */
.success-banner{position:fixed;top:90px;left:50%;transform:translateX(-50%);background:var(--co);color:#fff;padding:12px 24px;border-radius:10px;font-size:12px;font-weight:600;z-index:1000;opacity:0;transition:opacity .3s;pointer-events:none;box-shadow:0 6px 20px rgba(76,217,100,.4)}
.success-banner.show{opacity:1}
</style>
</head>
<body>

<div id="loading">
  <div class="ld-logo">BIM<span>Progress</span></div>
  <div class="ld-bar"><div class="ld-fill" id="ld-fill"></div></div>
  <div class="ld-txt" id="ld-txt">Initializing viewerâ€¦</div>
</div>

<div class="success-banner" id="successBanner">âœ“ Viewer initialized successfully</div>

<canvas id="canvas"></canvas>

<div id="toolbar">
  <span class="brand">BIMProgress</span>
  <div class="sep"></div>
  <button class="btn" id="btn-fit">ğŸ¯ Fit All</button>
  <button class="btn" id="btn-top">â¬† Top</button>
  <button class="btn" id="btn-front">â–¦ Front</button>
  <div class="sep"></div>
  <button class="btn" id="btn-wire">â¬¡ Wireframe</button>
  <button class="btn" id="btn-xray">â—‰ X-Ray</button>
  <div class="sep"></div>
  <button class="btn" id="btn-shot">ğŸ“¸ Export</button>
</div>

<div id="panel-l">
  <div class="ph">ğŸ“Š Project Overview</div>
  <div class="stats">
    <div class="sbox"><div class="sval" id="st-total">0</div><div class="slbl">Elements</div></div>
    <div class="sbox"><div class="sval" id="st-pct" style="color:var(--co)">0%</div><div class="slbl">Complete</div></div>
    <div class="sbox"><div class="sval" id="st-ip" style="color:var(--ip)">0</div><div class="slbl">In Progress</div></div>
    <div class="sbox"><div class="sval" id="st-oh" style="color:var(--oh)">0</div><div class="slbl">On Hold</div></div>
  </div>
  <div class="prog-wrap">
    <div class="prog-lbl"><span>Overall Progress</span><span id="prog-pct">0%</span></div>
    <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>
  <div class="ph">ğŸ¨ Status Filter</div>
  <div class="legend" id="legend"></div>
  <div class="ph">ğŸ“‹ Active Tasks</div>
  <div class="task-list" id="task-list"></div>
</div>

<div id="panel-r">
  <div class="pr-head">
    <h3>Element Details</h3>
    <button class="pr-close" id="pr-close">Ã—</button>
  </div>
  <div class="pr-body" id="pr-body"></div>
</div>

<div id="floor-filter">
  <span>Floor</span>
  <button class="fbtn active" data-floor="all">All</button>
  <button class="fbtn" data-floor="B1">B1</button>
  <button class="fbtn" data-floor="L1">L1</button>
  <button class="fbtn" data-floor="L2">L2</button>
  <button class="fbtn" data-floor="L3">L3</button>
  <button class="fbtn" data-floor="Roof">Roof</button>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (typeof THREE === 'undefined') {
  document.getElementById('ld-txt').textContent = 'âŒ Three.js failed to load. Check your internet connection.';
  document.getElementById('ld-fill').style.cssText = 'width:100%;background:#ff3b30';
  throw new Error('Three.js CDN failed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STRUCTURES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = { NS:'Not Started', IP:'In Progress', CO:'Complete', OH:'On Hold', UR:'Under Review' };

const SCOL = {
  'Not Started':'#5a6580','In Progress':'#f5a623','Complete':'#4cd964',
  'On Hold':'#ff3b30','Under Review':'#5ac8fa'
};
const SHEX = {
  'Not Started':0x5a6580,'In Progress':0xf5a623,'Complete':0x4cd964,
  'On Hold':0xff3b30,'Under Review':0x5ac8fa
};

const TASKS = [
  {id:'T001',name:'Foundation & Footings',   disc:'Structure',   floor:'B1',  status:S.CO, pct:100},
  {id:'T002',name:'Basement Slab',           disc:'Structure',   floor:'B1',  status:S.CO, pct:100},
  {id:'T003',name:'L1 Columns & Cores',      disc:'Structure',   floor:'L1',  status:S.CO, pct:100},
  {id:'T004',name:'L1 Floor Slab',           disc:'Structure',   floor:'L1',  status:S.CO, pct:100},
  {id:'T005',name:'L1 Exterior Walls',       disc:'Architecture',floor:'L1',  status:S.CO, pct:100},
  {id:'T006',name:'L1 Interior Partitions',  disc:'Architecture',floor:'L1',  status:S.IP, pct:75 },
  {id:'T007',name:'L1 Doors & Windows',      disc:'Architecture',floor:'L1',  status:S.IP, pct:60 },
  {id:'T008',name:'L1 MEP Rough-in',         disc:'MEP',         floor:'L1',  status:S.IP, pct:40 },
  {id:'T009',name:'L2 Columns & Cores',      disc:'Structure',   floor:'L2',  status:S.CO, pct:100},
  {id:'T010',name:'L2 Floor Slab',           disc:'Structure',   floor:'L2',  status:S.IP, pct:80 },
  {id:'T011',name:'L2 Exterior Walls',       disc:'Architecture',floor:'L2',  status:S.IP, pct:50 },
  {id:'T012',name:'L2 Interior Partitions',  disc:'Architecture',floor:'L2',  status:S.NS, pct:0  },
  {id:'T013',name:'L3 Structure',            disc:'Structure',   floor:'L3',  status:S.IP, pct:30 },
  {id:'T014',name:'L3 Envelope',             disc:'Architecture',floor:'L3',  status:S.NS, pct:0  },
  {id:'T015',name:'Roof Structure',          disc:'Structure',   floor:'Roof',status:S.NS, pct:0  },
  {id:'T016',name:'Roof Waterproofing',      disc:'Architecture',floor:'Roof',status:S.NS, pct:0  },
  {id:'T017',name:'Staircase S-01',          disc:'Structure',   floor:'L1',  status:S.OH, pct:20 },
  {id:'T018',name:'Lift Shaft & Pit',        disc:'Structure',   floor:'B1',  status:S.UR, pct:90 },
  {id:'T019',name:'Curtain Wall Facade',     disc:'Architecture',floor:'L1',  status:S.IP, pct:35 },
  {id:'T020',name:'Electrical Main Dist.',   disc:'MEP',         floor:'B1',  status:S.CO, pct:100},
];

const FY = {B1:-4, L1:0, L2:4, L3:8, Roof:12};
const FH = 4;

function buildElements() {
  const els = [];
  const grid = [];
  for(let r=-2;r<=2;r++) for(let c=-2;c<=2;c++) grid.push([r*4,c*4]);
  const colTask = {B1:'T001',L1:'T003',L2:'T009',L3:'T013'};
  ['B1','L1','L2','L3'].forEach(fl => {
    grid.forEach(([cx,cz],i) => {
      els.push({id:`COL-${fl}-${i}`,name:`Column ${fl}-${String(i+1).padStart(2,'0')}`,
        type:'IfcColumn',floor:fl,category:'Columns',taskId:colTask[fl],
        pos:{x:cx,y:FY[fl]+FH/2,z:cz},size:{w:.5,h:FH,d:.5},ry:0});
    });
  });
  const slabTask = {B1:'T002',L1:'T004',L2:'T010',L3:'T013',Roof:'T015'};
  ['B1','L1','L2','L3','Roof'].forEach(fl => {
    els.push({id:`SLAB-${fl}`,name:`Floor Slab ${fl}`,
      type:'IfcSlab',floor:fl,category:'Floors',taskId:slabTask[fl],
      pos:{x:0,y:FY[fl]+.15,z:0},size:{w:19,h:.3,d:19},ry:0});
  });
  const wallTask = {L1:'T005',L2:'T011',L3:'T014'};
  ['L1','L2','L3'].forEach(fl => {
    const wy = FY[fl]+FH/2;
    [
      {id:`EW-${fl}-N`,name:`Ext Wall ${fl} North`,x:0,  z:-9.5,ry:0,          w:19,h:FH,d:.35},
      {id:`EW-${fl}-S`,name:`Ext Wall ${fl} South`,x:0,  z: 9.5,ry:0,          w:19,h:FH,d:.35},
      {id:`EW-${fl}-W`,name:`Ext Wall ${fl} West`, x:-9.5,z:0,  ry:Math.PI/2,  w:19,h:FH,d:.35},
      {id:`EW-${fl}-E`,name:`Ext Wall ${fl} East`, x: 9.5,z:0,  ry:Math.PI/2,  w:19,h:FH,d:.35},
    ].forEach(w => {
      els.push({id:w.id,name:w.name,type:'IfcWall',floor:fl,category:'Walls',taskId:wallTask[fl],
        pos:{x:w.x,y:wy,z:w.z},size:{w:w.w,h:w.h,d:w.d},ry:w.ry});
    });
  });
  [{id:'IW-L1-01',x:-3,z:0,ry:0},{id:'IW-L1-02',x:3,z:0,ry:0},
   {id:'IW-L1-03',x:0,z:-3,ry:Math.PI/2},{id:'IW-L1-04',x:0,z:3,ry:Math.PI/2},
   {id:'IW-L2-01',x:-3,z:0,ry:0,fl:'L2'},{id:'IW-L2-02',x:3,z:0,ry:0,fl:'L2'}
  ].forEach((p) => {
    const fl = p.fl||'L1';
    els.push({id:p.id,name:`Partition ${p.id}`,type:'IfcWall',floor:fl,category:'Partitions',
      taskId:fl==='L1'?'T006':'T012',
      pos:{x:p.x,y:FY[fl]+1.5,z:p.z},size:{w:5.5,h:3,d:.12},ry:p.ry});
  });
  els.push({id:'LIFT-01',name:'Lift Shaft',type:'IfcShaft',floor:'B1',category:'Shafts',taskId:'T018',
    pos:{x:7,y:6,z:7},size:{w:2.4,h:16,d:2.4},ry:0});
  els.push({id:'CW-01',name:'Curtain Wall South',type:'IfcCurtainWall',floor:'L1',category:'Facades',taskId:'T019',
    pos:{x:0,y:FY.L1+FH/2,z:9.7},size:{w:9,h:FH,d:.1},ry:0});
  for(let i=0;i<8;i++) {
    els.push({id:`STAIR-01-step${i}`,name:'Staircase S-01',type:'IfcStair',floor:'L1',category:'Stairs',taskId:'T017',
      pos:{x:-6,y:FY.L1+i*0.22+.11,z:-6+i*.32},size:{w:2.2,h:.22,d:.32},ry:0});
  }
  return els;
}

const ELEMENTS = buildElements();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENE & GLOBALS - DECLARED HERE (IMPORTANT: before applyOrb definition)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scene, camera, renderer, raycaster, mouse;
const meshMap = {};
let wireMode=false, xrayMode=false, selectedId=null, activeFloor='all';
const activeStatuses = new Set(Object.values(S));
let toastTid;

function taskFor(el) { return TASKS.find(t=>t.id===el.taskId)||null; }
function statusFor(el) { const t=taskFor(el); return t?t.status:S.NS; }
function makeMat(status) {
  return new THREE.MeshStandardMaterial({
    color:SHEX[status]||SHEX[S.NS], roughness:.7, metalness:.1
  });
}
function setLoad(msg,pct) {
  document.getElementById('ld-txt').textContent=msg;
  document.getElementById('ld-fill').style.width=pct+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORBIT CONTROLS - NOTE: applyOrb() will be called AFTER camera is created
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const orb={theta:.75,phi:1.0,r:46,tx:0,ty:4,tz:0,active:false,btn:-1,lx:0,ly:0};

function applyOrb() {
  // CRITICAL: Guard against calling this before camera is initialized
  if (!camera) {
    console.warn('applyOrb() called before camera initialized - skipping');
    return;
  }
  camera.position.set(
    orb.tx+orb.r*Math.sin(orb.phi)*Math.sin(orb.theta),
    orb.ty+orb.r*Math.cos(orb.phi),
    orb.tz+orb.r*Math.sin(orb.phi)*Math.cos(orb.theta)
  );
  camera.lookAt(orb.tx,orb.ty,orb.tz);
}

function setupOrbit() {
  const cv=document.getElementById('canvas');
  cv.addEventListener('mousedown',e=>{orb.active=true;orb.btn=e.button;orb.lx=e.clientX;orb.ly=e.clientY});
  window.addEventListener('mousemove',e=>{
    if(!orb.active) return;
    const dx=e.clientX-orb.lx, dy=e.clientY-orb.ly;
    orb.lx=e.clientX; orb.ly=e.clientY;
    if(orb.btn===0){
      orb.theta-=dx*.008;
      orb.phi=Math.max(.15,Math.min(Math.PI-.12,orb.phi+dy*.008));
    } else if(orb.btn===2){
      const right=new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0),
        new THREE.Vector3(orb.tx-camera.position.x,0,orb.tz-camera.position.z)).normalize();
      orb.tx+=right.x*dx*.032; orb.tz+=right.z*dx*.032; orb.ty+=dy*.032;
    }
    applyOrb();
  });
  window.addEventListener('mouseup',()=>orb.active=false);
  cv.addEventListener('wheel',e=>{
    orb.r=Math.max(10,Math.min(90,orb.r+e.deltaY*.045));
    applyOrb();
    e.preventDefault();
  },{passive:false});
  cv.addEventListener('contextmenu',e=>e.preventDefault());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENE INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initScene() {
  setLoad('Setting up rendererâ€¦',15);

  renderer = new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(innerWidth,innerHeight);
  renderer.shadowMap.enabled=true;
  renderer.shadowMap.type=THREE.PCFSoftShadowMap;

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0e17);
  scene.fog = new THREE.Fog(0x0a0e17,75,140);

  // CREATE CAMERA - This must happen before applyOrb() is called
  camera = new THREE.PerspectiveCamera(48,innerWidth/innerHeight,.1,220);
  camera.position.set(32,26,32);
  camera.lookAt(0,4,0);

  // NOW it's safe to call applyOrb() since camera exists
  console.log('âœ“ Camera initialized, applying orbit position');
  applyOrb();

  setLoad('Adding lightingâ€¦',30);

  scene.add(new THREE.AmbientLight(0xffffff,.48));
  const sun = new THREE.DirectionalLight(0xfff8f0,1.2);
  sun.position.set(24,34,20); sun.castShadow=true;
  sun.shadow.mapSize.set(2048,2048);
  ['left','right','top','bottom'].forEach((k,i)=>sun.shadow.camera[k]=[-24,24,24,-24][i]);
  sun.shadow.camera.far=85;
  scene.add(sun);
  const fill=new THREE.DirectionalLight(0x9dbbff,.32);
  fill.position.set(-16,9,-16); scene.add(fill);

  const grid=new THREE.GridHelper(48,24,0x1e2842,0x1e2842); 
  grid.position.y=-4.45; scene.add(grid);
  const gm=new THREE.Mesh(new THREE.PlaneGeometry(70,70),
    new THREE.MeshStandardMaterial({color:0x0d1420,roughness:1}));
  gm.rotation.x=-Math.PI/2; gm.position.y=-4.48; gm.receiveShadow=true; 
  scene.add(gm);

  setLoad('Building geometryâ€¦',50);

  ELEMENTS.forEach(el => {
    const geo = new THREE.BoxGeometry(el.size.w,el.size.h,el.size.d);
    const mat = makeMat(statusFor(el));
    const mesh = new THREE.Mesh(geo,mat);
    mesh.position.set(el.pos.x,el.pos.y,el.pos.z);
    if(el.ry) mesh.rotation.y=el.ry;
    mesh.castShadow=true; mesh.receiveShadow=true;
    mesh.userData.eid=el.id;
    scene.add(mesh);
    meshMap[el.id]=mesh;
  });

  raycaster=new THREE.Raycaster();
  mouse=new THREE.Vector2();

  setLoad('Configuring controlsâ€¦',75);
  setupOrbit();
  setupPick();
  setupToolbar();
  setupFloorFilter();
  buildTaskList();
  buildLegend();
  updateStats();

  setLoad('Ready!',100);
  setTimeout(()=>{
    document.getElementById('loading').style.cssText='opacity:0;transition:opacity .6s;pointer-events:none';
    setTimeout(()=>{
      document.getElementById('loading').style.display='none';
      document.getElementById('toolbar').classList.add('vis');
      document.getElementById('panel-l').classList.add('vis');
      document.getElementById('floor-filter').classList.add('vis');
      showSuccessBanner();
    },620);
  },350);

  animate();
}

function showSuccessBanner() {
  const banner = document.getElementById('successBanner');
  banner.classList.add('show');
  setTimeout(() => banner.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ELEMENT PICKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let downX=0,downY=0;
function setupPick() {
  const cv=document.getElementById('canvas');
  cv.addEventListener('mousedown',e=>{downX=e.clientX;downY=e.clientY});
  cv.addEventListener('mouseup',e=>{
    if(Math.abs(e.clientX-downX)>5||Math.abs(e.clientY-downY)>5) return;
    mouse.set((e.clientX/innerWidth)*2-1,-(e.clientY/innerHeight)*2+1);
    raycaster.setFromCamera(mouse,camera);
    const meshes=[];
    scene.traverse(o=>{if(o.isMesh&&o.userData.eid) meshes.push(o)});
    const hits=raycaster.intersectObjects(meshes,false);
    if(!hits.length){deselect();return;}
    selectEl(hits[0].object.userData.eid);
  });
}

function selectEl(id) {
  deselect();
  selectedId=id;
  const mesh=meshMap[id];
  if(mesh){mesh.material.emissive=new THREE.Color(0x4a8fff);mesh.material.emissiveIntensity=.45;}
  document.querySelectorAll('.titem').forEach(t=>t.classList.remove('sel'));
  const el=ELEMENTS.find(e=>e.id===id);
  if(!el) return;
  const ti=document.querySelector(`.titem[data-tid="${el.taskId}"]`);
  if(ti){ti.classList.add('sel');ti.scrollIntoView({block:'nearest'});}
  showInfo(el);
}

function deselect() {
  if(selectedId){
    const m=meshMap[selectedId];
    if(m) m.material.emissiveIntensity=0;
  }
  selectedId=null;
  document.getElementById('panel-r').classList.remove('show');
  document.querySelectorAll('.titem').forEach(t=>t.classList.remove('sel'));
}

function showInfo(el) {
  const task=taskFor(el);
  const st=task?task.status:S.NS;
  const col=SCOL[st];
  document.getElementById('pr-body').innerHTML=`
    <div class="pr-row"><div class="pr-key">Element ID</div><div class="pr-val">${el.id}</div></div>
    <div class="pr-row"><div class="pr-key">Name</div><div class="pr-val">${el.name}</div></div>
    <div class="pr-row"><div class="pr-key">IFC Type</div><div class="pr-val">${el.type}</div></div>
    <div class="pr-row"><div class="pr-key">Floor Â· Category</div><div class="pr-val">${el.floor} Â· ${el.category}</div></div>
    ${task?`
    <div class="pr-row"><div class="pr-key">Task</div><div class="pr-val">${task.id} â€” ${task.name}</div></div>
    <div class="pr-row"><div class="pr-key">Discipline</div><div class="pr-val">${task.disc}</div></div>
    <div class="pr-row"><div class="pr-key">Status</div>
      <span class="pr-badge" style="background:${col}25;color:${col};border:1px solid ${col}55">${st}</span>
    </div>
    <div class="pr-row"><div class="pr-key">Progress</div>
      <div style="margin-top:6px">
        <div style="height:6px;background:#1e2842;border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${task.pct}%;background:${col};border-radius:3px;transition:width .5s"></div>
        </div>
        <div style="font-size:10px;color:${col};margin-top:4px;font-family:monospace">${task.pct}%</div>
      </div>
    </div>`:`<div class="pr-row"><div class="pr-key">Status</div><div class="pr-val">No task mapped</div></div>`}
  `;
  document.getElementById('panel-r').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupToolbar() {
  document.getElementById('btn-fit').onclick=()=>{
    Object.assign(orb,{theta:.75,phi:1.0,r:46,tx:0,ty:4,tz:0});applyOrb();toast('View reset');
  };
  document.getElementById('btn-top').onclick=()=>{
    orb.phi=.18;orb.r=42;applyOrb();toast('Top view');
  };
  document.getElementById('btn-front').onclick=()=>{
    orb.theta=0;orb.phi=Math.PI/2;orb.r=42;applyOrb();toast('Front view');
  };
  document.getElementById('btn-wire').onclick=function(){
    wireMode=!wireMode;this.classList.toggle('active',wireMode);
    scene.traverse(o=>{if(o.isMesh&&o.userData.eid) o.material.wireframe=wireMode;});
    toast(wireMode?'Wireframe on':'Wireframe off');
  };
  document.getElementById('btn-xray').onclick=function(){
    xrayMode=!xrayMode;this.classList.toggle('active',xrayMode);
    scene.traverse(o=>{
      if(o.isMesh&&o.userData.eid){
        o.material.transparent=xrayMode;
        o.material.opacity=xrayMode?.32:1;
        o.material.depthWrite=!xrayMode;
      }
    });
    toast(xrayMode?'X-Ray on':'X-Ray off');
  };
  document.getElementById('btn-shot').onclick=()=>{
    renderer.render(scene,camera);
    const a=document.createElement('a');
    a.download=`bim-progress-${Date.now()}.png`;
    a.href=renderer.domElement.toDataURL('image/png');
    a.click();toast('Screenshot saved');
  };
  document.getElementById('pr-close').onclick=deselect;
}

function setupFloorFilter() {
  document.querySelectorAll('.fbtn').forEach(b=>{
    b.onclick=function(){
      document.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
      activeFloor=this.dataset.floor;
      applyVis();
      toast('Floor: '+(activeFloor==='all'?'All':activeFloor));
    };
  });
}

function applyVis() {
  ELEMENTS.forEach(el=>{
    const mesh=meshMap[el.id]; if(!mesh) return;
    const flOk=activeFloor==='all'||el.floor===activeFloor;
    const stOk=activeStatuses.has(statusFor(el));
    mesh.visible=flOk&&stOk;
  });
}

function buildLegend() {
  const counts={};
  Object.values(S).forEach(s=>counts[s]=0);
  const seen=new Set();
  ELEMENTS.forEach(el=>{
    const key=el.taskId+el.floor;
    if(!seen.has(key)){seen.add(key);counts[statusFor(el)]++;}
  });
  const c=document.getElementById('legend');
  c.innerHTML='';
  Object.values(S).forEach(s=>{
    const col=SCOL[s];
    const d=document.createElement('div');
    d.className='li'; d.dataset.s=s;
    d.innerHTML=`<div class="lswatch" style="background:${col}"></div><span class="lname">${s}</span><span class="lcount">${counts[s]}</span>`;
    d.onclick=()=>{
      if(activeStatuses.has(s)){activeStatuses.delete(s);d.classList.add('off');}
      else{activeStatuses.add(s);d.classList.remove('off');}
      applyVis();
    };
    c.appendChild(d);
  });
}

function buildTaskList() {
  const list=document.getElementById('task-list');
  list.innerHTML='';
  TASKS.forEach(t=>{
    const col=SCOL[t.status];
    const d=document.createElement('div');
    d.className='titem'; d.dataset.tid=t.id;
    d.innerHTML=`<div class="tname">${t.name}</div>
      <div class="tmeta"><span>${t.id}</span>
      <span style="color:${col};font-weight:700">${t.pct}%</span>
      <span class="tstatus" style="background:${col}28;color:${col}">${t.status}</span></div>`;
    d.onclick=()=>{
      const el=ELEMENTS.find(e=>e.taskId===t.id);
      if(el) selectEl(el.id);
    };
    list.appendChild(d);
  });
}

function updateStats() {
  const seen=new Set(); let co=0,ip=0,oh=0,total=0;
  ELEMENTS.forEach(el=>{
    if(seen.has(el.taskId)) return; seen.add(el.taskId); total++;
    const s=statusFor(el);
    if(s===S.CO) co++;
    if(s===S.IP) ip++;
    if(s===S.OH) oh++;
  });
  const pct=Math.round(co/total*100);
  document.getElementById('st-total').textContent=ELEMENTS.length;
  document.getElementById('st-pct').textContent=pct+'%';
  document.getElementById('st-ip').textContent=ip;
  document.getElementById('st-oh').textContent=oh;
  document.getElementById('prog-pct').textContent=pct+'%';
  document.getElementById('prog-fill').style.width=pct+'%';
}

function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTid); toastTid=setTimeout(()=>t.classList.remove('show'),2200);
}

window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

function animate() { requestAnimationFrame(animate); renderer.render(scene,camera); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START APPLICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',()=>{
  if(typeof THREE==='undefined'){
    document.getElementById('ld-txt').textContent='âŒ Three.js CDN unavailable';
    document.getElementById('ld-fill').style.cssText='width:100%;background:#ff3b30';
    return;
  }
  console.log('ğŸ—ï¸ BIM Progress Viewer - Starting initialization');
  initScene();
});
</script>
</body>
</html>
